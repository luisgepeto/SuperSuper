name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Make scripts executable
        run: chmod +x ./.github/scripts/adjust-paths.sh

      - name: Adjust paths for GitHub Pages
        run: ./.github/scripts/adjust-paths.sh /SuperSuper/

      - name: Create custom 404.html for SPA routing
        run: |
          cat > dist/404.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
            <head>
              <meta charset="utf-8">
              <title>SuperSuper - Redirecting...</title>
              <script>
                // Single Page Apps for GitHub Pages
                // https://github.com/rafgraph/spa-github-pages
                // This script takes the current url and converts the path and query
                // string into just a query string, and then redirects to the new url
                // with only a query string and hash fragment
                var pathSegmentsToKeep = 1;
                var l = window.location;
                l.replace(
                  l.protocol + '//' + l.hostname + (l.port ? ':' + l.port : '') +
                  l.pathname.split('/').slice(0, 1 + pathSegmentsToKeep).join('/') + '/?/' +
                  l.pathname.slice(1).split('/').slice(pathSegmentsToKeep).join('/').replace(/&/g, '~and~') +
                  (l.search ? '&' + l.search.slice(1).replace(/&/g, '~and~') : '') +
                  l.hash
                );
              </script>
            </head>
            <body>
            </body>
          </html>
          EOF

      - name: Add redirect script to index.html
        run: |
          # Create a temporary file with the script tag
          echo '    <script>' > /tmp/redirect-script.txt
          cat .github/scripts/spa-redirect.js >> /tmp/redirect-script.txt
          echo '    </script>' >> /tmp/redirect-script.txt
          
          # Insert the script before </head> in index.html
          sed -i -e "/<\/head>/r /tmp/redirect-script.txt" dist/index.html

      - name: Add .nojekyll file
        run: touch dist/.nojekyll

      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
          publish_branch: gh-pages
          force_orphan: true
